{% extends "base.html" %}
{% import "base.html" as base %}
{% import "post_helpers.html" as post_helpers %}

{% block head %}
{% call base::draw_embed("", "Search DIVA mods", "") %}
{% endblock head %}

{% block content %}
<script>
	async function new_search() {
		document.getElementById("posts").innerHTML = "";
		search();
	}

	async function search() {
		document.getElementById("loadMore").hidden = true;

		var query = document.getElementById("searchQuery").value;
		var sort = document.getElementById("searchSort").value;
		var filter = document.getElementById("searchFilter").value;

		var params = new URLSearchParams();
		params.append("query", query);
		params.append("sort", sort);
		params.append("filter", filter);
		params.append("limit", "40");
		params.append("offset", document.getElementById("posts").children.length);

		var posts = await fetch("https://divamodarchive.com/api/v1/posts?" + params.toString()).then(req => req.json());

		for (var post of posts) {
			document.getElementById("posts").append(getPostHtml(post));
		}

		if (document.getElementById("posts").children.length % 40 == 0) {
			document.getElementById("loadMore").hidden = false;
		}
	}
</script>
<div style="display: flex; justify-content: center;">
	<div class="row row-cols-2 row-cols-md-4">
		<div class="col flex-md-grow-1">
			<input onchange="search()" class="form-control list-text" type="text" placeholder="Query" name="query"
				id="searchQuery" autocomplete="off">
		</div>
		<div class="col flex-md-grow-1">
			<select onchange="search()" name="sort" id="searchSort" class="form-control list-text">
				<option value="time:desc">Newest</option>
				<option value="time:asc">Oldest</option>
				<option value="download_count:desc">Downloads</option>
				<option value="like_count:desc">Likes</option>
			</select>
		</div>
		<div class="col flex-md-grow-1">
			<select onchange="search()" name="filter" id="searchFilter" class="form-control list-text">
				<option value="">Any</option>
				<option value="post_type=Song">Song</option>
				<option value="post_type=Cover">Cover</option>
				<option value="post_type=Module">Module</option>
				<option value="post_type=UI">UI</option>
				<option value="post_type=Plugin">Plugin</option>
				<option value="post_type=Other">Other</option>
			</select>
		</div>
	</div>
</div>
<br>
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-3" id="posts">
</div>
<button class="btn btn-sm btn-primary" type="button" id="loadMore" onClick="search" hidden>Load more</button>
<script>search();</script>
{% endblock content %}
